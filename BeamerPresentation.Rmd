---
title: "Case Study 1"
author: 
  - "Emily Gentles"
  - "Phuc Nguyen"
  - "Joseph Lawson"
date: "Jan 21, 2020"
output: beamer_presentation
---

# Case Discussion

- Data obtained from a subset of women enrolled in the CPP during pregnancy
- Data issues: uncertainty, inflation, and missingness

**Goal**: Assess how exposure to DDE and PCBs relates to the risk of premature delivery

Graph?

# Exploratory Data Analysis


```{r}

```

# Analysis

- Keep obs with Gest. Age 44 or less
- Categorize Gest. Age to assess risks of pre-term births of varying severity
- Impute score data with MICE
- Remove obs with missing PCE, DDE


```{r, echo=FALSE, eval = FALSE}
library(tidyverse)
library(mice)
library(nnet)
library(corrplot)
library(quantreg)
library(MASS)
library(effects)
library(knitr)
set.seed(43)

Long <- readRDS("Longnecker.rds")
Long <- Long %>% mutate(albuminTested = ifelse(is.na(albumin), 0, 1)) %>% filter(gestational_age <= 44)
Long = Long %>% mutate(termCat = cut(gestational_age, c(breaks = c(0, 32, 37 ,45))), center = as.character(center),
                       pcb = pcb_028 + pcb_052 + pcb_074 + pcb_105 + pcb_118 + pcb_153 + pcb_170 +
                            pcb_138 + pcb_180 + pcb_194 + pcb_203,
                       # ed_norm = qnorm(score_education / 100),
                       # inc_norm = qnorm(score_education / 100),
                       # occ_norm = qnorm(score_occupation / 100),
                       dde.cut = cut(dde, breaks = 5),
                       pcb.cut = cut(pcb, breaks = 5),
                       gestord = factor(termCat, ordered = TRUE)
                       ) %>% filter(!is.na(pcb))


# ADD PRINCIPLE COMPONENTs
pcbmat = as.matrix(Long %>% dplyr::select(colnames(Long)[grepl("pcb_", colnames(Long))]))
pcb.pr = prcomp(pcbmat, center = T, scale = T)

Long = Long %>% mutate(PCB1 = pcb.pr$x[,1], PCB2 = pcb.pr$x[,2], PCB3 = pcb.pr$x[,3])

##

# Long_Score_NA_rm = Long %>% filter(!is.na(score_education + score_occupation + score_income))
# modordscore = polr(gestord ~ center + log(dde) + log(pcb) + score_education + score_occupation + score_education + log(triglycerides) + maternal_age + smoking_status + cholesterol + albuminTested, data = Long_Score_NA_rm)
# modordscorecomp = polr(gestord~ center+log(dde) + log(pcb)+log(triglycerides) + maternal_age + smoking_status + cholesterol + albuminTested, data = Long_Score_NA_rm)
# anova(modordscore, modordscorecomp)
# 
# modordcenter = polr(gestord~ center*log(dde) + center*log(pcb) + log(triglycerides) + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)
# modord = polr(gestord~ center+log(dde) + log(pcb)+log(triglycerides)  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)
# summary(modord)
# anova(modord, modordcenter)


### BASE MODEL

Long.Base.Mod = polr(gestord~ center + dde + PCB1 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long,
                     Hess = T)

Base.Confint = confint(Long.Base.Mod)

knitr::kable(Base.Confint)

### PCA Analysis ###

Long.PCA.1.2.3 = polr(gestord~ center + dde + PCB1 + PCB2 + PCB3 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)

Long.PCA.1 = polr(gestord~ center + dde + PCB1 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)


Long.PCA.logged = polr(gestord~ center + log(dde)*log(PCB1) + log(triglycerides)  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)


PCA.anova = anova(Long.PCA.1, Long.PCA.1.2.3)

#############################################
### MICE with ORDLOG - check score usefulness
#############################################

impLong = mice(Long, printFlag = F)
imp.OL.Mod = with(impLong, polr(gestord ~ center + score_occupation +score_education +
                                  score_income + dde + PCB1 + 
                                    triglycerides  + maternal_age + smoking_status + 
                                    cholesterol + albuminTested, Hess = T))

imp.OL.Mod.wo.score = with(impLong, polr(gestord ~ center  + dde + PCB1 + 
                                    triglycerides  + maternal_age + smoking_status + 
                                    cholesterol + albuminTested, Hess = T))

score.p.value = pool.compare(imp.OL.Mod, imp.OL.Mod.wo.score)$pvalue

MICE.summary = summary(pool(imp.OL.Mod))

##########################################
###### Check Center Interactions/inclusion
##########################################

center.inter.mod = polr(gestord~ center *(dde + PCB1 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested), data = Long)

Center.Inter.Anova = anova(center.inter.mod, Long.Base.Mod)

## Note that center interaction not significant

no.center.mod = polr(gestord~ dde + PCB1 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)

Center.Inclusion.Anova = anova(no.center.mod, Long.Base.Mod)


##########################################
#### Check Chemical interactions
##########################################


## DDE PCA Interaction
Long.PCA.DDE.Inter.Mod = polr(gestord~ center + dde * PCB1 + triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)

DDE.PCA.Inter.Anova = anova(Long.Base.Mod, Long.PCA.DDE.Inter.Mod)


## DDE/PCA Triglyceride Interaction
Long.Trig.Inter.Mod = polr(gestord~ center + dde*triglycerides + PCB1*triglycerides  + maternal_age + smoking_status + cholesterol + albuminTested, data = Long)

Trig.Inter.Anov = anova(Long.Base.Mod, Long.Trig.Inter.Mod)


```

# Results


# Discussion
