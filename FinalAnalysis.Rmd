---
title: "Final Report"
author: "Phuc Nguyen, Joseph Lawson, Emily Gentles"
date: "1/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Abstract/Summary - summarize the problem and the main findings of your project.

# Section 1: Introduction - provide an initial description of the data, study in which it was
collected and focus of the study/analysis/questions of interest.

# Section 2: Materials & Methods - describe the statistical approach/approaches used in the
analysis, providing references as appropriate; do not present results in this section but just the
methods used. You can carry out your analysis with multiple methods.

# Section 3: Results - describe the results of the analysis approaches described in Section 2. It
may be useful to break this into subsections, such as:
– 3.1 Exploratory Data Analysis
– 3.2 Main Results
– 3.3 Sensitivity Analysis
Make sure to very clearly address the questions of interest!

### EDA

```{r, library, message=FALSE, results=FALSE}
library(tidyverse)
library(mice)
library(MASS)
library(GGally)
```

```{r, clean-data}
longnecker_base <- readRDS(file = "Longnecker.rds")

# Keep gestational age less than 45
# Remove 1 row of pcb_* with NA
# Dichotomize gestational age into 4 categories
# Create indicator of albumin
# Change center to categorical
gestational_age_cutoff <- 45
longnecker <- longnecker_base %>%
  filter(gestational_age < gestational_age_cutoff) %>%
  filter(!is.na(pcb_028)) %>%
  mutate(has_albumin = 1 * !is.na(albumin)) %>%
  mutate(center = as.character(center)) %>%
  mutate(gestational_cat = as.factor(ifelse(gestational_age <= 32, 1, 
                                            ifelse(gestational_age <= 37 & gestational_age > 32, 2,
                                                   ifelse(gestational_age > 37 & gestational_age <= 41, 3, 4)))))

# Log transform pcb_* after adding a small number to 0 values
pcb_mat <- longnecker %>%
                    dplyr::select(contains("pcb")) %>%
                    data.matrix()
min_pcb <- min(pcb_mat[pcb_mat > 0])
pcb_mat[pcb_mat == 0] <- min_pcb / 2
pcb_mat <- apply(pcb_mat, 2, log)
# Summarize pcb_* with PCA
pcb_pca <- prcomp(pcb_mat, scale = TRUE)
# To see loading of each variable, uncomment the below:
#pcb_pca$rotation[, 1] * (pcb_mat[1, ] - pcb_pca$center)/ pcb_pca$scale
# To see variation explained by each PC, uncomment the below:
# pcb_pca$sdev^2 # == > two PCs are enough
pcb_comps <- pcb_mat %*% pcb_pca$rotation[, c(1,2)]
longnecker["pcb_pca1"] <- pcb_comps[, 1]
longnecker["pcb_pca2"] <- pcb_comps[, 2]

# Log transform these variables
longnecker["log_dde"] <- log(longnecker$dde)
longnecker["log_tri"] <- log(longnecker$triglycerides)
```

```{r, viz-collinear, message=FALSE}
ggpairs(longnecker %>% dplyr::select(gestational_cat, log_dde, pcb_pca1, log_tri, cholesterol, maternal_age))
```

```{r}
ggplot(longnecker, aes(x = gestational_age)) + geom_histogram(bins = 15)
ggplot(longnecker, aes(x = gestational_cat)) + geom_bar()
ggplot(longnecker, aes(fill = race, x = gestational_cat)) + geom_bar()
ggplot(longnecker, aes(x = dde)) + geom_histogram()
longnecker %>%
  dplyr::select(pcb_170, pcb_138, pcb_203) %>%
  gather(key = "var", value = "val") %>%
  ggplot(aes(x = val)) + geom_histogram(bins=30) + facet_wrap(~var)
ggplot(longnecker, aes(x = pcb_pca1)) + geom_histogram()
ggplot(longnecker, aes(y = pcb_pca1, x = gestational_cat)) + geom_boxplot()
ggplot(longnecker, aes(y = triglycerides, x = gestational_cat)) + geom_boxplot()
ggplot(longnecker, aes(y = cholesterol, x = gestational_cat)) + geom_boxplot()
ggplot(longnecker, aes(fill = as.factor(smoking_status), x = gestational_cat)) + geom_bar()
ggplot(longnecker, aes(fill = gestational_cat, x = center)) + geom_bar()
longnecker %>%
  dplyr::select(contains("score"), gestational_cat) %>%
  gather(key = "variable", value = "value", - gestational_cat) %>%
  ggplot(aes(colour = gestational_cat, y = value, x = variable)) + geom_boxplot()
ggplot(longnecker, aes(x = gestational_cat, y = maternal_age)) + geom_boxplot()
longnecker %>%
  mutate(has_albumin = as.factor(has_albumin)) %>%
  ggplot(aes(y = gestational_age, x = has_albumin)) + geom_boxplot()
```

### Ordered logistic regression

```{r, ord}
ord_mod <- polr(gestational_cat ~ race +
                 log_dde + 
                 pcb_pca1 +
                 has_albumin +
                 poly(maternal_age, 2)+ 
                 log_tri +
                 cholesterol +
                 smoking_status +
                 center, 
               data = longnecker,
               Hess=TRUE)
p_ord <- pnorm(abs(coef(summary(ord_mod))[, "t value"]), lower.tail = FALSE) * 2
cbind(summary(ord_mod)$coefficients, p_ord)
```

```{r, diagnostics-linearity}
# Tutorial from http://www.sthda.com/english/articles/36-classification-methods-essentials/148-logistic-regression-assumptions-and-diagnostics-in-r/
probabilities <- predict(ord_mod, type = "probs")
predictors <- c("log_dde", 
                 "pcb_pca1",
                 "log_tri",
                 "cholesterol",
                 "severe_premature", "premature", "normal"
                )
longnecker %>%
  mutate(severe_premature = log(probabilities[, 1]/(1-probabilities[, 1])),
         premature = log(probabilities[, 2]/(1-probabilities[, 2])),
         normal = log(probabilities[, 3]/(1-probabilities[, 3]))
         ) %>%
  dplyr::select(predictors) %>%
  gather(key = "predictors", value = "predictor.value", 
         -severe_premature, -premature, -normal) %>%
  gather(key = "categories", value = "logit.value", -predictors, -predictor.value) %>%
  ggplot(aes(logit.value, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_grid(cols = vars(categories), rows = vars(predictors), scales = "free")
```

We use package `brant` to test the proportional odds assumption (from this post here: https://medium.com/evangelinelee/brant-test-for-proportional-odds-in-r-b0b373a93aa2). The assumption holds at the 0.05 level.

```{r, diagnostics-prop-odds}
library(brant)
test_mod <- polr(gestational_cat ~ race +
                 log_dde + 
                 pcb_pca1 +
                 has_albumin +
                 maternal_age + 
                 log_tri +
                 cholesterol +
                 smoking_status +
                 center, 
               data = longnecker,
               Hess=TRUE)
brant(test_mod)
```

### Sensitivity Analysis

```{r, sensitivity-count, cache=TRUE}
y <- longnecker$gestational_cat
n <- 200
y_hat <- matrix(NA, nrow = length(y), ncol = n)
for (i in 1:n) {
  y_hat[, i] <- apply(probabilities, 1, function(x) {which(rmultinom(1, 1, x) == 1)})
}

# Distribution of count of each category in the simulated data
count_severe <- apply(y_hat, 2, function(x) {sum(x == 1)})
count_mild <- apply(y_hat, 2, function(x) {sum(x == 2)})
count_normal <- apply(y_hat, 2, function(x) {sum(x == 3)})
sens_data <- data.frame(severe = count_severe, mild = count_mild, normal = count_normal) %>%
  gather(key = "categories", value = "count")
ggplot(sens_data, aes(x = count, fill = categories)) + 
  geom_histogram(bins = 200) +
  geom_vline(xintercept = 69, color = "red", size = 0.5) +
  geom_vline(xintercept = 453, color = "red", size = 0.5) +
  geom_vline(xintercept = 1789, color = "red", size = 0.5)
```

```{r, sensitivity-cutoff, cache=TRUE}
ci <- confint(ord_mod)
ci_df <- data.frame(ci) %>%
  rownames_to_column() %>%
  mutate(model = "32-37 (main)")
cutoffs <- list(c(31, 36), c(33, 38), c(31, 38))
for (cutoff in cutoffs) {
  longnecker_test <- longnecker %>%
    mutate(gestational_cat = as.factor(ifelse(gestational_age <= cutoff[1], 1, 
                                       ifelse(gestational_age <= cutoff[2] & gestational_age > cutoff[1], 2, 3))))
  test_mod <- polr(gestational_cat ~ race +
                 log_dde + 
                 pcb_pca1 +
                 has_albumin +
                 poly(maternal_age, 2) + 
                 log_tri +
                 cholesterol +
                 smoking_status +
                 center, 
               data = longnecker_test,
               Hess=TRUE)
  ci <- confint(test_mod)
  df <- data.frame(ci) %>% rownames_to_column() %>% mutate(model = paste0(cutoff[1], "-", cutoff[2]))
  ci_df <- rbind(ci_df, df)
}
pd <- position_dodge(0.2)
ci_df["mean"] <- (ci_df$X2.5.. + ci_df$X97.5..)/2
ggplot(ci_df %>% filter(rowname %in% c("raceblack", "log_dde", "pcb_pca1", "has_albumin", "log_tri", "cholesterol")), 
       aes(y=mean, x=rowname, colour=model)) + 
  geom_errorbar(aes(ymin=X2.5.., ymax=X97.5..), width=.2, position=pd)
```

# Section 4: Discussion - comment on advantages and disadvantages of the approach taken and
briefly discuss other approaches you could have taken instead.

# Appendix - contains any necessary technical and other material that would be good to include
but may make the main part difficult to read, particularly for a non-specialist/scientist. Sections
1-4 should be as accessible as possible to a non-statistician scientist/researcher in the relevant
area & should be written in a clear/concise manner.